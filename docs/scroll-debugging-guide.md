# Руководство по устранению проблем аудио и скролла

## 1. Симптомы

### Проблемы со скроллом
- **Рывок после остановки**: при `stopHighlighting()` страница подпрыгивала вверх, потому что мы снимали класс `.current` и провоцировали reflow.
- **Скачки при смене куплета**: `scrollIntoView({behavior:'smooth'})` запускало новую анимацию поверх старой, и смещение доходило до 150 px.
- **Хаос при зацикливании**: Howler резко отдавал `seek()` в начало, а мы успевали запустить конкурирующие плавные скроллы в разные стороны.

### Проблемы с аудио
- **Высокий голос при увеличении скорости**: Web Audio API (`html5: false`) меняет pitch вместе со скоростью.
- **Нет подсветки строк в Яндекс браузере**: HTML5 Audio возвращает некорректные значения `seek()` в некоторых браузерах.

## 2. Ошибочные подходы
- **setInterval(…, 100)**: опрос плеера раз в 100 мс не синхронизирован с анимацией и только накапливает отставания.
- **Удаление `.current`**: это вызывало reflow и усиливало дерганье.
- **setTimeout на 100/400 мс**: добавить задержки не значит устранить гонку скроллов.
- **Жёсткий `window.scrollTo()` при rewind**: рывок исчез, но и плавность пропала.

## 3. Рабочее решение

### Для скролла
- **RAF вместо интервала**: `startHighlighting()` крутится на `requestAnimationFrame`, а `stopHighlighting()` делает `cancelAnimationFrame`. Теперь подсветка обновляется ровно каждый кадр.
- **Фильтр по `deltaSeek`**: если `|deltaSeek| < MIN_DELTA_SEEK`, пропускаем кадр, чтобы не реагировать на микрошумы.
- **Отдельная обработка rewind**: `deltaSeek < REWIND_THRESHOLD` или резкий прыжок `currentTime` означает возврат в начало. Мы отменяем текущую анимацию, сбрасываем `visitedStanzas` и запускаем `scrollAnimator` со сниженной длительностью `REWIND_DURATION`.
- **Сохранение `.current`**: подсветку не снимаем — это исключает лишний reflow.

### Для аудио
- **HTML5 Audio вместо Web Audio API**: `html5: true` в Howl сохраняет нормальный pitch при изменении скорости через `playbackRate`.
- **Валидация seek()**: проверяем что `sound.seek()` возвращает число, а не объект - в некоторых браузерах HTML5 Audio может давать некорректные значения.
- **Буфер для точности**: добавлен буфер 50ms при поиске текущей строки, чтобы компенсировать погрешности `seek()` в HTML5 Audio.

## 4. Чему учит опыт
- **Один планировщик — одна анимация**. Не смешивайте `setInterval` и плавные скроллы, иначе получите гонки.
- **Логируйте подробности**. Трассировка `rafTick`, `scrollRequest`, `scrollDispatch` помогла увидеть настоящую картину.
- **Фильтруйте шум**. Маленькие колебания таймкода не должны перезапускать подсветку и скролл.
- **Убирайте старые костыли**. После перехода на RAF мы удалили `highlightInterval` и связанные проверочные таймеры, чтобы код оставался читаемым.
- **Отключайте логи в проде**. Используйте флаг `DEBUG_SCROLL = false`, чтобы консоль не зашумлялась в продакшене.
- **Выносите магические числа**. Константы типа `REWIND_THRESHOLD`, `MIN_DELTA_SEEK` делают код понятнее и позволяют легко подстраивать поведение.

## 5. Настройка констант

Для удобства все магические числа вынесены в константы в начале блока подсветки:

```javascript
var DEBUG_SCROLL = false;             // Включить для отладки скролла (логи в консоль)
var DEBUG_AUDIO = false;              // Включить для диагностики аудио (seek, rate, duration)
var MIN_DELTA_SEEK = 0.005;           // Минимальное изменение позиции для обновления
var REWIND_THRESHOLD = -0.05;         // Порог для определения отката назад
var REWIND_DURATION = 250;            // Длительность анимации при rewind (мс)
var NORMAL_SCROLL_DURATION = 600;     // Обычная длительность скролла (мс)
var SEEK_BUFFER = 0.05;               // Буфер для HTML5 Audio seek() (в highlightCurrentLine)
```

**Когда менять:**
- `MIN_DELTA_SEEK` — если подсветка слишком часто мерцает или наоборот запаздывает
- `REWIND_THRESHOLD` — если ложно срабатывает детекция отката при обычных переходах
- `REWIND_DURATION` — для более плавного/резкого возврата к началу
- `SEEK_BUFFER` — если подсветка часто промахивается мимо строк в HTML5 Audio
- `DEBUG_SCROLL` — временно включите на `true` для диагностики проблем скролла
- `DEBUG_AUDIO` — временно включите на `true` для диагностики проблем с seek() и воспроизведением

## 6. Что делать, если проблема вернётся

### Проблемы со скроллом
1. Включите `DEBUG_SCROLL = true` и соберите логи (`traceHighlight`, `traceScroll`).
2. Проверьте, не запущена ли одновременно старая анимация.
3. Убедитесь, что `deltaSeek` фильтруется корректно.
4. В Safari протестируйте отдельно — там Howler может чаще "прыгать".
5. Если нужен ещё более плавный контроль, подключите библиотеку с отменяемыми скроллами (например, GSAP ScrollTo).

### Проблемы с аудио
1. **Высокий голос при изменении скорости**: убедитесь что `html5: true` в настройках Howl.
2. **Нет подсветки в браузере**: включите `DEBUG_AUDIO = true` и проверьте логи:
   - Если `seek` возвращает не число - валидация работает корректно
   - Если `seek` возвращает странные значения - увеличьте `SEEK_BUFFER`
3. **Рывки/скачки**: проверьте `MIN_DELTA_SEEK` - возможно нужно увеличить порог
4. В Яндекс браузере смотрите предупреждения "Invalid seek()" в консоли

Следуя этим шагам, можно удержать скролл плавным, аудио качественным, а код — чистым.
